name: Ralph Loop Validation

on:
  push:
    branches: [ mirror ]
  pull_request:
    branches: [ mirror ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: mirror
    
    - name: Check AGENTS.md exists
      run: |
        if [ ! -f AGENTS.md ]; then
          echo "❌ AGENTS.md not found"
          exit 1
        fi
        echo "✅ AGENTS.md exists"
    
    - name: Verify directory structure
      run: |
        mkdir -p staging/artifacts staging/logs staging/backups
        echo "✅ Directory structure verified"
    
    - name: Check for artifact file
      run: |
        if [ -f staging/artifacts/deathmatch.html ]; then
          echo "✅ Artifact exists"
          ls -lh staging/artifacts/deathmatch.html
        else
          echo "⚠️  Artifact not yet created"
        fi
    
    - name: Validate artifact size
      run: |
        if [ -f staging/artifacts/deathmatch.html ]; then
          SIZE=$(stat -c%s staging/artifacts/deathmatch.html)
          MAX_SIZE=512000  # 500KB in bytes
          
          if [ $SIZE -lt $MAX_SIZE ]; then
            echo "✅ Artifact size: $(numfmt --to=iec-i --suffix=B $SIZE) (limit: 500KB)"
          else
            echo "❌ Artifact too large: $(numfmt --to=iec-i --suffix=B $SIZE) (limit: 500KB)"
            exit 1
          fi
        fi
    
    - name: Check for external dependencies
      run: |
        if [ -f staging/artifacts/deathmatch.html ]; then
          if grep -qE '(http://|https://)' staging/artifacts/deathmatch.html; then
            echo "❌ External URLs detected in artifact"
            grep -nE '(http://|https://)' staging/artifacts/deathmatch.html | head -20
            exit 1
          else
            echo "✅ No external dependencies detected"
          fi
        fi
    
    - name: Verify mobile tap targets
      run: |
        if [ -f staging/artifacts/deathmatch.html ]; then
          if grep -qE '(min-height|min-width)\s*:\s*[0-9]+(px|rem|em)' staging/artifacts/deathmatch.html; then
            echo "✅ Tap target styling detected"
          else
            echo "⚠️  No explicit tap target sizing found"
          fi
        fi
    
    - name: Check for No_Gas_Labs™ branding
      run: |
        if [ -f staging/artifacts/deathmatch.html ]; then
          if grep -qi 'No_Gas_Labs\|No Gas Labs' staging/artifacts/deathmatch.html; then
            echo "✅ No_Gas_Labs™ branding present"
          else
            echo "⚠️  No_Gas_Labs™ branding not found"
          fi
        fi
    
    - name: Parse AGENTS.md progress
      run: |
        if [ -f AGENTS.md ]; then
          COMPLETE=$(grep -c '\[x\]' AGENTS.md || echo 0)
          TOTAL=$(grep -c '\[[ x]\]' AGENTS.md || echo 0)
          PERCENT=$((COMPLETE * 100 / TOTAL))
          echo "✅ Progress: $COMPLETE/$TOTAL features complete ($PERCENT%)"
        fi
