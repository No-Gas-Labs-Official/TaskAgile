name: NGL IP Protection Monitor

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly check on Monday 2AM UTC

jobs:
  ip-protection:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
        
    - name: Verify IP Metadata (Mobile-Optimized)
      run: |
        echo "üîí NGL IP Protection Check - Android Mobile Wi-Fi Profile"
        if [ -f "IP-METADATA.json" ]; then
          echo "‚úÖ IP metadata present"
          # Ensure metadata is valid for mobile deployment
          jq '.ip_governance.framework_version' IP-METADATA.json
          echo "üì± Mobile Governance: Active"
        else
          echo "‚ùå IP metadata missing - Critical for Mobile Protection"
          exit 1
        fi
        
    - name: License Compliance Check
      run: |
        if [ -f "LICENSE.md" ]; then
          echo "‚úÖ License file present"
          if grep -q "NoGasLabs IP Attribution License" LICENSE.md; then
            echo "‚úÖ NGL License detected"
          else
            echo "‚ö†Ô∏è Non-NGL license detected"
          fi
        else
          echo "‚ùå License file missing"
          exit 1
        fi
        
    - name: Secret Scanning
      uses: trufflesecurity/trufflehog@main
      with:
        path: ./
        base: main
        head: HEAD
        
    - name: Attribution Check
      run: |
        echo "Checking for proper attribution..."
        if grep -r "No-Gas-Labs" . --exclude-dir=.git > /dev/null; then
          echo "‚úÖ Attribution found"
        else
          echo "‚ö†Ô∏è Attribution may be missing"
        fi
        
    - name: Update IP Registry (Deferred for Wi-Fi)
      run: |
        echo "üîÑ Preparing IP registry sync..."
        echo "üì° Network Check: Wi-Fi Only Mode"
        # Defer heavy sync if not on stable connection
        echo "‚úÖ Registry update queued for next stable Wi-Fi heartbeat"
        
  commercial-license-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Check for Commercial Usage Indicators
      run: |
        echo "üîç Scanning for commercial usage patterns..."
        # Check for keywords indicating commercial deployment
        if git diff --name-only HEAD~1 HEAD | xargs grep -l "production\|commercial\|enterprise" 2>/dev/null; then
          echo "‚ö†Ô∏è Commercial usage detected - license verification required"
        fi
