#!/usr/bin/env bash
# No_Gas_Labsâ„¢ Rollback Script
# Auto-generated by Ralph Loop
# Last updated: Iteration 1

set -euo pipefail

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "No_Gas_Labsâ„¢ Ralph Loop Rollback Utility"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Check we're on mirror branch
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
if [[ "$BRANCH" != "mirror" ]]; then
  echo "âŒ Not on mirror branch (currently: $BRANCH)"
  exit 1
fi

echo "Available rollback points (last 20):"
echo ""
git tag -l "rollback-iter-*" | sort -Vr | head -20 | while read -r tag; do
  ITER=$(echo "$tag" | sed 's/rollback-iter-//')
  VALIDATED=$(git tag -l "validated-iter-$ITER" | wc -l)
  if [ "$VALIDATED" -eq 1 ]; then
    echo "  âœ… Iteration $ITER (validated)"
  else
    echo "  âš ï¸  Iteration $ITER (not validated)"
  fi
done

echo ""
echo "Current iteration: $(cat staging/ralph_state.json | grep -o '"iteration":[0-9]*' | cut -d: -f2)"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Enter iteration number to rollback to (or 'cancel'):"
read -r ITER

if [ "$ITER" = "cancel" ] || [ -z "$ITER" ]; then
  echo "âŒ Rollback cancelled"
  exit 0
fi

# Validate iteration number
if ! [[ "$ITER" =~ ^[0-9]+$ ]]; then
  echo "âŒ Invalid iteration number: $ITER"
  exit 1
fi

TAG="rollback-iter-$ITER"

# Check tag exists
if ! git tag -l | grep -q "^$TAG$"; then
  echo "âŒ Rollback point not found: $TAG"
  echo "Available tags:"
  git tag -l "rollback-iter-*" | sort -Vr | head -10
  exit 1
fi

# Show what will be lost
CURRENT_ITER=$(cat staging/ralph_state.json | grep -o '"iteration":[0-9]*' | cut -d: -f2)
LOST_ITERS=$((CURRENT_ITER - ITER))

echo ""
echo "âš ï¸  WARNING: This will rollback $LOST_ITERS iteration(s)"
echo "âš ï¸  Current: iteration $CURRENT_ITER"
echo "âš ï¸  Target:  iteration $ITER"
echo "âš ï¸  All work from iterations $((ITER+1)) to $CURRENT_ITER will be LOST"
echo ""
echo "Type 'ROLLBACK' to confirm (case-sensitive):"
read -r CONFIRM

if [ "$CONFIRM" != "ROLLBACK" ]; then
  echo "âŒ Rollback cancelled (confirmation failed)"
  exit 0
fi

echo ""
echo "ğŸ”„ Rolling back to iteration $ITER..."

# Create emergency backup tag
EMERGENCY_TAG="emergency-backup-$(date +%Y%m%d-%H%M%S)"
git tag "$EMERGENCY_TAG"
echo "âœ… Emergency backup created: $EMERGENCY_TAG"

# Perform rollback
git reset --hard "$TAG"

# Force push with lease (safer than --force)
git push origin mirror --force-with-lease || {
  echo "âŒ Push failed - restoring from emergency backup"
  git reset --hard "$EMERGENCY_TAG"
  exit 1
}

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… ROLLBACK COMPLETE"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Rolled back to: iteration $ITER"
echo "Emergency backup: $EMERGENCY_TAG (can be deleted later)"
echo ""
echo "To continue Ralph loop from this point:"
echo "  1. Verify state: cat staging/ralph_state.json"
echo "  2. Resume: (Manus will auto-detect and continue)"
echo ""
